{
  "name": "Workflow A - Historique Quotidien",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 1 * * *"
            }
          ]
        }
      },
      "id": "uuid-trigger",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [
        240,
        400
      ],
      "typeVersion": 1.2,
      "notes": "‚è∞ CRON: 23h30 UTC = 00h30 Paris (heure d'hiver UTC+1)\n‚ö†Ô∏è Ajust√© car n8n ignore timezone et utilise UTC\nüîÑ Passer √† 22h30 en √©t√© (UTC+2)"
    },
    {
      "parameters": {
        "jsCode": "// Calculer la date J-1 (hier)\nconst yesterday = new Date();\nyesterday.setDate(yesterday.getDate() - 1);\n\n// Format ISO (YYYY-MM-DD)\nconst yesterdayDate = yesterday.toISOString().split('T')[0];\n\nreturn [{\n  json: {\n    date: yesterdayDate,\n    year: yesterday.getFullYear(),\n    month: yesterday.getMonth() + 1,\n    day: yesterday.getDate()\n  }\n}];"
      },
      "id": "uuid-prep",
      "name": "Pr√©paration Date J-1",
      "type": "n8n-nodes-base.code",
      "position": [
        464,
        400
      ],
      "typeVersion": 2,
      "notes": "üìÖ Calcule la date d'HIER (J-1)\nSortie: {date: 'YYYY-MM-DD', year, month, day}"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "mode": "list",
          "value": "u2Dc3JzuRlYinZZr",
          "cachedResultName": "[SUB] APsystems - Donn√©es Quotidiennes"
        },
        "options": {}
      },
      "id": "uuid-call-aps",
      "name": "Appel SUB APsystems J-1",
      "type": "n8n-nodes-base.executeWorkflow",
      "position": [
        688,
        400
      ],
      "typeVersion": 1.1,
      "notes": "üîå Appelle SUB APsystems avec date J-1\nR√©cup√®re production/consommation r√©elles du jour pr√©c√©dent"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "iTqe8WKnm0cfsE1B",
          "mode": "list",
          "cachedResultName": "energy_hourly",
          "cachedResultUrl": "/projects/HmXlcweiu5I7NsBE/datatables/iTqe8WKnm0cfsE1B"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "date",
              "keyValue": "={{ $('Pr√©paration Date J-1').item.json.date }}"
            }
          ]
        },
        "returnAll": true
      },
      "id": "uuid-read-dt",
      "name": "Lecture Data Table J-1",
      "type": "n8n-nodes-base.dataTable",
      "position": [
        912,
        400
      ],
      "typeVersion": 1,
      "notes": "üìñ Lit TOUTES les entr√©es horaires de J-1 dans Data Table\n‚ö†Ô∏è Contient ~24 lignes (une par heure) avec forecast_day_kwh variable"
    },
    {
      "parameters": {
        "jsCode": "// R√©cup√©rer les donn√©es APsystems J-1\nconst apsData = $('Appel SUB APsystems J-1').first().json;\n\n// R√©cup√©rer les donn√©es de pr√©vision depuis la Data Table\nlet dataTableRows = $('Lecture Data Table J-1').all();\n\nif (!apsData || !apsData.today) {\n  throw new Error('Donn√©es APsystems manquantes');\n}\n\nif (dataTableRows.length === 0) {\n  throw new Error('Aucune pr√©vision trouv√©e dans la Data Table energy_hour pour J-1');\n}\n\n// TRIER les lignes par heure (croissant) pour √™tre s√ªr d'avoir le d√©but de journ√©e\ndataTableRows.sort((a, b) => {\n  const hA = a.json.hour || 0;\n  const hB = b.json.hour || 0;\n  return hA - hB;\n});\n\n// Production r√©elle du jour\nconst realProduction = apsData.today.produced;\n\n// ‚úÖ CORRECTION: Prendre la PREMI√àRE pr√©vision du jour (ex: 06h), pas la derni√®re\n// On cherche la premi√®re ligne qui a une pr√©vision > 0 (pour √©viter les 0 de la nuit si jamais)\nlet forecastRow = dataTableRows.find(row => (row.json.forecast_day_kwh || 0) > 0);\n\n// Fallback sur la premi√®re ligne si tout est √† 0\nif (!forecastRow) {\n  forecastRow = dataTableRows[0];\n}\n\nconst forecastProduction = forecastRow.json.forecast_day_kwh || 0;\n\n// Pour information: nombre de pr√©visions disponibles\nconst forecastCount = dataTableRows.length;\n\n// Calculer les √©carts\nconst ecartKwh = realProduction - forecastProduction;\nconst ecartPct = forecastProduction > 0 \n  ? parseFloat(((ecartKwh / forecastProduction) * 100).toFixed(2))\n  : 0;\n\n// Pr√©parer les donn√©es pour Google Sheets\nconst result = {\n  date: apsData.date,\n  production_reelle_kwh: parseFloat(realProduction.toFixed(2)),\n  prevision_kwh: parseFloat(forecastProduction.toFixed(2)),\n  ecart_kwh: parseFloat(ecartKwh.toFixed(2)),\n  ecart_pct: ecartPct,\n  consommation_kwh: parseFloat(apsData.today.consumed.toFixed(2)),\n  importe_kwh: parseFloat(apsData.today.imported.toFixed(2)),\n  exporte_kwh: parseFloat(apsData.today.exported.toFixed(2)),\n  autoconsommation_pct: apsData.today.autoconsumption || 0,\n  autosuffisance_pct: apsData.today.autosufficiency || 0,\n  \n  // M√©tadonn√©es pour debug\n  nb_previsions_dispo: forecastCount,\n  heure_prevision_utilisee: forecastRow.json.hour || 'N/A'\n};\n\nreturn [{ json: result }];"
      },
      "id": "uuid-calc",
      "name": "Calcul √âcarts et Moyennes",
      "type": "n8n-nodes-base.code",
      "position": [
        1120,
        400
      ],
      "typeVersion": 2,
      "notes": "üßÆ Compare production r√©elle vs pr√©vision J-1\nüêõ BUG: Prend DERNI√àRE pr√©vision (23h) au lieu de PREMI√àRE (01h)\n‚úÖ √Ä CORRIGER: Utiliser dataTableRows[0] (premi√®re pr√©vision du jour)"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1MHFGECBWHFgl0VNcXwIdnTyx9-OoWmHrHdglP7LurJ0",
          "mode": "list",
          "cachedResultName": "APsystems - Historique Quotidien",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1MHFGECBWHFgl0VNcXwIdnTyx9-OoWmHrHdglP7LurJ0/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": "gid=0",
          "cachedResultName": "Feuille 1"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Date": "={{ $json.date }}",
            "Production R√©elle (kWh)": "={{ $json.production_reelle_kwh }}",
            "Pr√©vision (kWh)": "={{ $json.prevision_kwh }}",
            "√âcart (kWh)": "={{ $json.ecart_kwh }}",
            "√âcart (%)": "={{ $json.ecart_pct }}",
            "Consommation (kWh)": "={{ $json.consommation_kwh }}",
            "Import√© (kWh)": "={{ $json.importe_kwh }}",
            "Export√© (kWh)": "={{ $json.exporte_kwh }}",
            "Autoconsommation (%)": "={{ $json.autoconsommation_pct }}",
            "Autosuffisance (%)": "={{ $json.autosuffisance_pct }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Date",
              "displayName": "Date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Production R√©elle (kWh)",
              "displayName": "Production R√©elle (kWh)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Pr√©vision (kWh)",
              "displayName": "Pr√©vision (kWh)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "√âcart (kWh)",
              "displayName": "√âcart (kWh)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "√âcart (%)",
              "displayName": "√âcart (%)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Consommation (kWh)",
              "displayName": "Consommation (kWh)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Import√© (kWh)",
              "displayName": "Import√© (kWh)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Export√© (kWh)",
              "displayName": "Export√© (kWh)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Autoconsommation (%)",
              "displayName": "Autoconsommation (%)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Autosuffisance (%)",
              "displayName": "Autosuffisance (%)",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "uuid-append",
      "name": "Ajouter ligne dans Sheet",
      "type": "n8n-nodes-base.googleSheets",
      "position": [
        1344,
        400
      ],
      "typeVersion": 4.5,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "mmpUz0PUHBtYApVA",
          "name": "Google Sheets account"
        }
      },
      "notes": "üìä Enregistre les r√©sultats dans Google Sheets\nFeuille: Historique quotidien production/pr√©vision"
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Pr√©paration Date J-1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pr√©paration Date J-1": {
      "main": [
        [
          {
            "node": "Appel SUB APsystems J-1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Appel SUB APsystems J-1": {
      "main": [
        [
          {
            "node": "Lecture Data Table J-1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lecture Data Table J-1": {
      "main": [
        [
          {
            "node": "Calcul √âcarts et Moyennes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcul √âcarts et Moyennes": {
      "main": [
        [
          {
            "node": "Ajouter ligne dans Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveManualExecutions": true,
    "saveExecutionProgress": true,
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "timezone": "Europe/Paris"
  },
  "versionId": "d401e3b1-b33f-48e6-99e7-678af1e34362",
  "meta": {
    "instanceId": "2194913e407b1e503ee1051e748fa0b50f28c847d89d91263b2430bdb12da207"
  },
  "id": "9V02WzToapyCQzhz",
  "tags": []
}