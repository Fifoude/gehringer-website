{
  "name": "[SUB] Forecast.Solar - PrÃ©vision Heure",
  "nodes": [
    {
      "parameters": {},
      "id": "uuid-trigger",
      "name": "Appel depuis workflow parent",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "position": [
        240,
        304
      ],
      "typeVersion": 1,
      "notes": "ðŸ”” Trigger SUB-workflow\nAppelÃ© par: Workflow B (temps rÃ©el)"
    },
    {
      "parameters": {
        "jsCode": "// Configuration centralisÃ©e\nconst SOLAR_CONFIG = {\n  latitude: 48.8782753,\n  longitude: 2.2268011,\n  declination: 5,\n  azimuth: 44,\n  power: 3.36,\n  timezone: 'Europe/Paris',\n  location: 'Suresnes, France'\n};\n\n// RÃ©cupÃ©rer la date/heure demandÃ©e (si fournie par le parent)\nconst input = $input.first().json;\nconst requestedTime = input.time || new Date().toISOString();\n\n// Construire l'URL forecast.solar pour prÃ©vision horaire\n// Format: /estimate/watthours/{lat}/{lon}/{dec}/{az}/{kwp}?time=YYYY-MM-DDTHH:MM:SS+TZ\nconst url = `https://api.forecast.solar/estimate/watthours/${SOLAR_CONFIG.latitude}/${SOLAR_CONFIG.longitude}/${SOLAR_CONFIG.declination}/${SOLAR_CONFIG.azimuth}/${SOLAR_CONFIG.power}?time=${encodeURIComponent(requestedTime)}`;\n\nreturn [{\n  json: {\n    solarConfig: SOLAR_CONFIG,\n    requestedTime: requestedTime,\n    url: url\n  }\n}];"
      },
      "id": "uuid-config",
      "name": "Configuration",
      "type": "n8n-nodes-base.code",
      "position": [
        464,
        304
      ],
      "typeVersion": 2,
      "notes": "âš™ï¸ Config Forecast.Solar - PrÃ©visions HORAIRES\nðŸ“… Input: time (ISO) ou maintenant par dÃ©faut\nðŸ”Ž API: /estimate/watthours (prÃ©visions cumulÃ©es par heure)"
    },
    {
      "parameters": {
        "url": "={{ $json.url }}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "uuid-http",
      "name": "RequÃªte Forecast Solar",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        688,
        304
      ],
      "typeVersion": 4.2,
      "notes": "ðŸŒ RequÃªte Forecast.Solar API\nTimeout: 10s | Retourne prÃ©visions heure par heure"
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst config = $('Configuration').item.json;\n\n// VÃ©rifier la rÃ©ponse API\nif (response.message && response.message.code !== 0) {\n  throw new Error(`Erreur Forecast.Solar (code ${response.message.code}): ${response.message.text || 'Erreur inconnue'}`);\n}\n\n// Extraire les prÃ©visions horaires\nconst result = response.result || {};\n\n// Convertir en tableau pour faciliter le traitement\nconst hourlyForecasts = Object.entries(result).map(([datetime, watthours]) => ({\n  datetime: datetime,\n  date: datetime.split(' ')[0],\n  time: datetime.split(' ')[1] || '00:00:00',\n  forecast_wh: parseFloat(watthours),\n  forecast_kwh: parseFloat((watthours / 1000).toFixed(3))\n}));\n\n// Convertir en timezone Europe/Paris\nconst timestamp = new Date().toLocaleString('sv-SE', { timeZone: 'Europe/Paris' }).replace(' ', 'T');\n\nconst output = {\n  timestamp: timestamp,\n  requestedTime: config.requestedTime,\n  hourlyForecasts: hourlyForecasts,\n  metadata: {\n    source: 'forecast.solar',\n    apiInfo: response.message || {},\n    timezone: config.solarConfig.timezone,\n    location: config.solarConfig.location\n  }\n};\n\nreturn [{ json: output }];"
      },
      "id": "uuid-format",
      "name": "Formatage DonnÃ©es",
      "type": "n8n-nodes-base.code",
      "position": [
        912,
        304
      ],
      "typeVersion": 2,
      "notes": "ðŸ“¦ Formatage rÃ©ponse:\n1. VÃ©rifie code API = 0\n2. Convertit {datetime: wh} en tableau hourlyForecasts\n3. Ajoute date, heure, kwh\nðŸ“Š Valeurs = cumul depuis minuit (pas production horaire)"
    }
  ],
  "pinData": {},
  "connections": {
    "Appel depuis workflow parent": {
      "main": [
        [
          {
            "node": "Configuration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Configuration": {
      "main": [
        [
          {
            "node": "RequÃªte Forecast Solar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RequÃªte Forecast Solar": {
      "main": [
        [
          {
            "node": "Formatage DonnÃ©es",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveManualExecutions": true,
    "saveExecutionProgress": true,
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "timezone": "Europe/Paris"
  },
  "versionId": "10716020-dd7e-4fe6-9ba6-b35fee05900c",
  "meta": {
    "instanceId": "2194913e407b1e503ee1051e748fa0b50f28c847d89d91263b2430bdb12da207"
  },
  "id": "nsco3pmEcQHA5Ax7",
  "tags": []
}